# NOTES_20251205_163136

## SemanticContext 導入

`execute_query` の引数 `embeddings` と `embedding_model` を `SemanticContext` dataclass にまとめた。

変更前:
```python
def execute_query(
    records: list[dict[str, Any]],
    sql: str,
    embeddings: dict[str, "np.ndarray"] | None = None,
    embedding_model: "EmbeddingModel | None" = None,
) -> dict[str, Any]:
```

変更後:
```python
@dataclass
class SemanticContext:
    embeddings: dict[str, "np.ndarray"]
    model: "EmbeddingModel"

def execute_query(
    records: list[dict[str, Any]],
    sql: str,
    semantic: SemanticContext | None = None,
) -> dict[str, Any]:
```

理由:
- `embeddings` と `embedding_model` は常にペアで渡す必要がある（両方あるか両方 None）
- 型で制約を表現することで暗黙の結合を明示化
- 将来の拡張（距離関数選択、閾値など）が容易

## コード品質レビュー

Serena MCP を使ってシンボル抽出・依存関係分析を実施。

評価結果:
- 責務分離: 8/10 - 各ファイルが明確な責務を持つ
- 凝集度: 8/10 - ファイル内容が一貫
- 結合度: 7/10 - server.py が多くのモジュールに依存
- 拡張性: 8/10 - 新機能追加が容易

## server.py 分割案

テスト構造 (`TestQuery`, `TestUpdate`, `TestBatch*`, `TestSemanticSearchTools`) に合わせた分割を検討。

```
src/frontmatter_mcp/
├── server.py          # FastMCP + main()
├── state.py (新規)    # グローバル状態 + get_* 関数
├── tools/  (新規)
│   ├── __init__.py
│   ├── query.py       # query_inspect, query
│   ├── update.py      # update
│   ├── batch.py       # batch_update, batch_array_*
│   └── index.py       # index_status, index_refresh
└── ...
```

結論: 現時点では実施せず、ツール追加時に検討。

## schema.py 改善

`defaultdict` を導入して値収集ループを簡潔化。

変更前:
```python
property_values: dict[str, list[Any]] = {}
for record in records:
    for key, value in record.items():
        if key == "path":
            continue
        if key not in property_values:
            property_values[key] = []
        property_values[key].append(value)
```

変更後:
```python
property_values: dict[str, list[Any]] = defaultdict(list)
for record in records:
    for key, value in record.items():
        if key != "path":
            property_values[key].append(value)
```

8行 -> 4行に削減。

## server.py 分割の検討

### ツール定義以外の部分

| 内容 | 責務 |
|------|------|
| グローバル状態 (`_base_dir`, `_embedding_*`, `_indexer`) | 状態管理 |
| `get_base_dir()`, `is_semantic_enabled()` | 状態アクセス・設定判定 |
| `get_embedding_model()`, `get_embedding_cache()`, `get_indexer()` | ファクトリ/DI |
| `collect_files()` | ファイル収集 |

### 検討した命名案

| 案 | 評価 |
|----|------|
| `util.py` | 責務が曖昧になりがち、避けたい |
| `state.py` | シンプルだが「状態」以外も含む |
| `runtime.py` | 「実行時に必要なもの」で責務が明確 |
| `config.py` | 設定のみなら良いが状態管理は含まない |

### FastMCP のツール分割パターン調査

- [FastMCP ドキュメント](https://gofastmcp.com/servers/tools): 複数ファイル分割の公式ガイドラインなし
- [GitHub Discussion #1312](https://github.com/jlowin/fastmcp/discussions/1312): `from tools import *` で登録トリガーする回避策が報告されているが "hacky" と認識
- [Issue #767](https://github.com/modelcontextprotocol/python-sdk/issues/767): FastAPI の APIRouter 的な機能が提案中

### 結論

FastMCP に公式パターンがないため、tools/ ディレクトリ分割は見送り。必要であれば runtime.py のみ切り出す方針。公式パターンが確立してから再検討。
