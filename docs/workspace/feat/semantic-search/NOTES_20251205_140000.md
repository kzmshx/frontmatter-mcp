# NOTES_20251205_140000

## PLAN レビューと設計変更

### 起動時の挙動変更

当初: 起動は即座、AI が `index_refresh()` を呼んで初期化

変更後: 起動時にバックグラウンドでインデキシング開始

理由:
- AI が初回に `index_refresh()` を呼ぶ必要がなくなる
- 状態が明確（インデキシング中 / 完了）

### インデキシング中の挙動

`indexing: true` の間は `embedding` カラムは使用不可とする。

理由:
- 中途半端な状態（一部だけ embedding あり）を避けられる
- AI が判断しやすい（使える / 使えない の二択）
- 実装もシンプル（完了後に一括で embedding カラムを追加）

### index_status の変更

当初:
```python
{
    "indexed_count": 660,
    "pending_count": 5,
    "last_updated": "2025-12-05T10:30:00",
    ...
}
```

変更後:
```python
{
    "indexing": false,
    "indexed_count": 660,
    ...
}
```

`pending_count` を削除し `indexing` フラグを追加。理由:
- `pending_count` の算出には対象ファイル一覧が必要だが glob 引数がなかった
- `indexing` フラグで十分（処理中か完了かが分かれば良い）

### index_refresh の変更

当初: `glob` 引数あり、同期的に実行

変更後: `glob` 引数なし（常に全ファイル）、バックグラウンドで実行

理由:
- 特定ディレクトリだけ更新すると他ファイルの embedding が NULL になる問題
- シンプルさを優先

### 本文の取得

python-frontmatter の `post.content` で本文を取得できることを確認。

```python
post = frontmatter.load(path)
content = post.content  # frontmatter 以降の本文
```

参考: https://python-frontmatter.readthedocs.io/en/latest/

## 実装準備完了

レビュー指摘事項をすべて解決:
1. `pending_count` の算出方法 → `indexing` フラグに変更
2. `glob` 引数と整合性 → `glob` 引数を削除
3. 本文の取得方法 → `post.content` で取得可能を確認

実装に移行可能。
