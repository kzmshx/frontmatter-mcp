# NOTES_20251205_155524

## Step 3 完了: Indexer モジュール

indexer.py を実装:
- threading による非同期インデキシング
- `is_indexing` / `indexed_count` プロパティで状態管理
- `start()` で開始、`wait()` で完了待機
- mtime 差分更新、削除ファイル検出に対応

test_indexer.py で 9 テスト追加、全てパス。

## Step 4 完了: Query への統合

query.py を拡張:
- `embeddings` / `embedding_model` パラメータ追加
- `_setup_semantic_search()` 関数で VSS セットアップ
  - `INSTALL vss; LOAD vss;`
  - `embed()` UDF 登録
  - `embeddings` テーブル作成、JOIN で `files` ビューに統合

test_query.py に TestSemanticSearch クラス追加（5テスト）。

### 発生した問題と解決

pyarrow で登録したテーブルを DROP TABLE できなかった:
```
CatalogException: Existing object files is of type View, trying to drop type Table
```

解決: `files_base` として登録し、`files` はビューとして作成:
```python
conn.register("files_base", table)
conn.execute("""
    CREATE VIEW files AS
    SELECT f.*, e.vector as embedding
    FROM files_base f
    LEFT JOIN embeddings e ON f.path = e.path
""")
```

## Step 5 開始: MCP ツール

test_server.py に TestSemanticSearchTools クラス追加:
- `test_index_status_disabled`: 無効時のレスポンス
- `test_index_status_enabled`: 有効時のレスポンス
- `test_index_refresh_disabled`: 無効時のエラー
- `test_index_refresh_enabled`: 有効時のインデキシング開始
- `test_query_with_semantic_search`: embed() を使ったクエリ

## Step 5 完了: MCP ツール

server.py に追加:
- 環境変数チェック (`is_semantic_enabled()`)
- グローバル状態管理 (`_embedding_model`, `_embedding_cache`, `_indexer`)
- `get_embedding_model()`, `get_embedding_cache()`, `get_indexer()` 遅延初期化
- `index_status` ツール: インデックス状態を返す
- `index_refresh` ツール: バックグラウンドインデキシング開始
- `query` ツール拡張: インデキシング完了後に embedding を渡す

cache.py に追加:
- `cache_path` プロパティ
- `get_all()` メソッド (dict 形式で全 embedding を返す)

test_server.py に TestSemanticSearchTools クラス追加（5テスト）。

## Step 6 完了: ドキュメント

README.md を更新:
- With Semantic Search セクション（uvx 設定例）
- index_status / index_refresh ツールドキュメント
- Semantic Search セクション（SQL 例、環境変数一覧）

## 完了

全 6 ステップ完了。115 テスト全てパス。
