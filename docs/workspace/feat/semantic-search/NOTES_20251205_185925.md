# NOTES_20251205_185925

## base_dir を pydantic-settings で必須フィールド化

前回の NOTES_20251205_190000 で `base_dir: Path | None = None` としていたが、テストのためにプロダクションコードを曲げていた問題を修正。

### 設計方針

`base_dir` は本来必須なので pydantic-settings で必須フィールドとして定義する。テストは環境変数 `FRONTMATTER_BASE_DIR` を `monkeypatch.setenv()` で設定する。

### lru_cache によるシングルトンパターン

pydantic-settings 公式の推奨パターンとして `@lru_cache` を使用:

```python
from functools import lru_cache

@lru_cache
def get_settings() -> Settings:
    """Get the cached settings instance."""
    return Settings()
```

アプリケーション起動時に一度だけ `Settings()` が呼ばれ、以降はキャッシュが返される。テストでは `get_settings.cache_clear()` でキャッシュをクリアできる。

参考:
- https://stackoverflow.com/questions/61582142/test-pydantic-settings-in-fastapi
- https://github.com/pydantic/pydantic-settings/issues/410

### settings.py

```python
from functools import lru_cache

class Settings(BaseSettings):
    model_config = SettingsConfigDict(env_prefix="FRONTMATTER_")

    base_dir: Path  # Required (no default)
    enable_semantic: bool = False
    embedding_model: str | None = None
    cache_dir: Path | None = None


@lru_cache
def get_settings() -> Settings:
    return Settings()
```

### context.py / server.py

グローバル `settings` インスタンスの代わりに `get_settings()` を呼び出すように変更:

```python
from frontmatter_mcp.settings import get_settings

def get_base_dir() -> Path:
    return get_settings().base_dir.resolve()
```

### tests/test_server.py

環境変数で設定し、キャッシュをクリア:

```python
from frontmatter_mcp.settings import get_settings

@pytest.fixture
def temp_base_dir(monkeypatch: pytest.MonkeyPatch):
    with tempfile.TemporaryDirectory() as tmpdir:
        base = Path(tmpdir)
        # ... create test files ...

        monkeypatch.setenv("FRONTMATTER_BASE_DIR", str(base))
        get_settings.cache_clear()
        yield base
        get_settings.cache_clear()
```

### メリット

- プロダクションコードがテストのために妥協していない
- `base_dir` が必須であることが型で明示される
- アプリケーション起動時に一度だけ環境変数を読み込み、以降はキャッシュ
- テストは標準的な `monkeypatch.setenv()` + `cache_clear()` で対応
