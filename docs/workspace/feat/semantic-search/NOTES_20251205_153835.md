# NOTES_20251205_153835

## Step 1: Embedding モジュール

実装ファイル:

- `src/frontmatter_mcp/embedding.py`
- `tests/test_embedding.py`

実装内容:

- `EmbeddingModel` クラス: 遅延ロード対応
- `encode()` / `encode_batch()`: テキスト → ベクトル変換
- `get_dimension()`: モデルから次元数を自動取得

発見:

- ruri-v3-30m の次元数は 256（当初 384 と想定していた）
- sentence-transformers の依存関係に protobuf と sentencepiece が必要

pyproject.toml の変更:

- optional-dependencies に semantic グループ追加
- pytest.ini_options に slow マーカー追加

## Step 2: キャッシュモジュール

実装ファイル:

- `src/frontmatter_mcp/cache.py`
- `tests/test_cache.py`

実装内容:

- `EmbeddingCache` クラス: DuckDB ベースの永続化キャッシュ
- embeddings テーブル: path, mtime, vector
- metadata テーブル: model_name, dimension
- `get_stale_paths()`: mtime 比較で更新が必要なファイルを検出
- `get_deleted_paths()`: 削除されたファイルを検出
- モデル変更時のキャッシュ自動クリア

テスト: 18 件すべて通過
