# NOTES_20251205_194448

## コード品質改善

### model.py の冗長 import 削除

`_load_model()` 内で `from sentence_transformers import SentenceTransformer` を再度 import していた。トップレベルで既に import 済みのため削除。

```python
# Before
def _load_model(self) -> None:
    try:
        from sentence_transformers import SentenceTransformer
    except ImportError as e:
        raise ImportError(...) from e
    self._model = SentenceTransformer(self._model_name)

# After
def _load_model(self) -> None:
    self._model = SentenceTransformer(self._model_name)
```

これに伴い `test_import_error_without_sentence_transformers` テストを削除。sentence-transformers は dev 依存として常にインストールされているため、このテストは実質意味がなくなった。

### cache.py の alias 削除

`db_path` と `cache_path` が同じものを指していた。外部 API として使われている `cache_path` を残し、`db_path` を削除。

```python
# Before
@property
def db_path(self) -> Path:
    return self._cache_dir / CACHE_DB_NAME

@property
def cache_path(self) -> Path:
    return self.db_path

# After
@property
def cache_path(self) -> Path:
    return self._cache_dir / CACHE_DB_NAME
```

### server.py の shadowing 修正

`conn_setup` 変数を `None` で初期化後、条件分岐内で同名の関数を定義していた。mypy では shadowing 警告が出る可能性があるため、`conn_setup_func` にリネーム。

```python
# Before
conn_setup = None
if get_settings().enable_semantic and is_indexing_ready():
    def conn_setup(conn) -> None:
        ...

# After
conn_setup_func = None
if get_settings().enable_semantic and is_indexing_ready():
    def conn_setup_func(conn) -> None:
        ...
```

## 依存バージョンの見直し

dev 依存のバージョン指定が厳しすぎたため緩和:

| パッケージ | Before | After |
|-----------|--------|-------|
| ruff | >=0.14.6 | >=0.14.0 |
| numpy | >=2.3.5 | >=2.0.0 |
| sentence-transformers | >=5.1.2 | >=2.0.0 |

本番依存（`dependencies`）と optional 依存（`semantic`）は適切なバージョン指定のため変更なし。
