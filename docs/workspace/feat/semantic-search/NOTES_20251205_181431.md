# NOTES_20251205_181431

## semantic/ ディレクトリの作成

セマンティック検索関連のコードを専用ディレクトリに整理。

変更前:

```
src/frontmatter_mcp/
├── embedding.py
├── embedding_cache.py
├── embedding_indexer.py
├── query.py          # SemanticContext, _setup_semantic_search を含む
└── server.py
```

変更後:

```
src/frontmatter_mcp/
├── config.py         # 設定の一元管理（新規）
├── query.py          # conn_setup コールバックを受け取る形に変更
├── server.py
└── semantic/
    ├── __init__.py
    ├── cache.py      # embedding_cache.py から移動
    ├── context.py    # シングルトン管理（新規、後で削除予定）
    ├── indexer.py    # embedding_indexer.py から移動
    ├── model.py      # embedding.py から移動
    └── query.py      # SemanticContext, setup_semantic_search を抽出
```

## query.py の疎結合化

`execute_query` の第3引数を `semantic: SemanticContext | None` から `conn_setup: Callable[[DuckDBPyConnection], None] | None` に変更。

これにより:

- query.py は semantic モジュールに依存しなくなった
- 将来的に他の DuckDB 拡張を追加する際も同じパターンで対応可能

## config.py の作成

環境変数を一元管理するモジュールを作成。

```python
# 環境変数名
ENV_ENABLE_SEMANTIC = "FRONTMATTER_ENABLE_SEMANTIC"
ENV_EMBEDDING_MODEL = "FRONTMATTER_EMBEDDING_MODEL"
ENV_CACHE_DIR = "FRONTMATTER_CACHE_DIR"

# 設定取得関数
is_semantic_enabled() -> bool
get_embedding_model_name() -> str | None
get_cache_dir(base_dir: Path) -> Path
```

## tests/ ディレクトリの整理

セマンティック検索関連のテストを `tests/semantic/` に移動。

```
tests/
├── semantic/
│   ├── __init__.py
│   ├── test_cache.py
│   ├── test_indexer.py
│   └── test_model.py
├── test_frontmatter.py
├── test_query.py
├── test_schema.py
└── test_server.py
```

## semantic/context.py の削除

シングルトン管理を `server.py` に統合し、`semantic/context.py` を削除。

変更内容:

- `server.py` に以下を追加:
  - グローバル変数: `_embedding_model`, `_embedding_cache`, `_indexer`
  - 関数: `get_embedding_model()`, `get_embedding_cache()`, `get_indexer()`, `is_indexing_ready()`
- `semantic/__init__.py` から context.py のエクスポートを削除
- `semantic/context.py` を削除

## pydantic-settings への移行と context.py の切り出し

設定管理を pydantic-settings に移行し、シングルトン管理を context.py に分離。

変更内容:

- `config.py` を `settings.py` にリネーム
- pydantic-settings の `BaseSettings` を使用した `Settings` クラスを導入
- 関数を廃止し、`settings` シングルトンを直接参照するように変更
- シングルトン管理 (`_embedding_model`, `_embedding_cache`, `_indexer`) を `context.py` に分離
- `pyproject.toml` に `pydantic-settings>=2.0.0` を追加

最終的な構成:

```text
src/frontmatter_mcp/
├── settings.py       # pydantic-settings による設定管理
├── context.py        # シングルトン管理（base_dir, model, cache, indexer）
├── query.py          # conn_setup コールバックを受け取る
├── server.py         # ツール定義のみ
└── semantic/
    ├── __init__.py
    ├── cache.py
    ├── indexer.py
    ├── model.py
    └── query.py      # SemanticContext, setup_semantic_search
```
