# NOTES_20251205_134600

## 検討事項の解決

### DuckDB VSS 拡張

M1 Mac での動作に問題なし。VSS は DuckDB コア拡張でプラットフォーム制約の記載なし。

注意点:
- HNSW インデックスはデータ投入後に作成が高速
- 永続化は `SET hnsw_enable_experimental_persistence = true` が必要（実験的）
- 削除は即時反映されない（`PRAGMA hnsw_compact_index()` で圧縮）

参考: https://duckdb.org/docs/stable/core_extensions/vss

### embed() 関数の DuckDB 登録

`create_function` で FLOAT 配列を返す UDF を登録可能。

```python
from duckdb.typing import VARCHAR
import numpy as np

def embed(sentence: str) -> np.ndarray:
    return model.encode(sentence)

conn.create_function("embed", embed, [VARCHAR], 'FLOAT[384]')
```

参考: https://blog.brunk.io/posts/similarity-search-with-duckdb/

### バックグラウンド更新

watchdog 常駐は不要と判断。理由:
- 過去のノート検索が主な用途（既にインデックス済み）
- 今書いたノートを即座に検索するケースは稀
- 複雑度とリソース消費を避ける

運用方針:
- AI が必要時に `index_refresh()` を明示的に呼ぶ
- ツール説明に「最新ファイルが見つからない場合は index_refresh() を実行」と記載

### テスト戦略

sentence-transformers のモック化で CI を高速化。

```python
@pytest.fixture
def mock_embedder(mocker):
    mock = mocker.patch('src.embedding.SentenceTransformer')
    mock.return_value.encode.return_value = np.random.rand(384)
    return mock

@pytest.mark.slow
def test_real_embedding(): ...
```

参考: https://flaviasalutari.github.io/blog/2023/pytest-for-transformers/

## ツール構成の変更

当初の設計:
- `index_status()`: 状態確認
- `index_rebuild()`: 全再構築

変更後:
- `index_status()`: 状態確認
- `index_refresh()`: 差分更新（初回は全件、以降は mtime 比較）

`index_rebuild()` は不要と判断。理由:
- モデル変更時: 環境変数変更 = サーバー再起動で自動検知
- キャッシュ破損時: 手動削除して再起動

## 起動時の挙動

当初: バックグラウンドで全ファイル embedding 生成

変更後:
- 起動は即座（ブロックしない）
- キャッシュなし → `indexed_count: 0` で起動
- AI が `index_refresh()` を呼んで初期化
