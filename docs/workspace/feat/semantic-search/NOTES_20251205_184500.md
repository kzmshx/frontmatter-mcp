# NOTES_20251205_184500

## pydantic-settings への移行

設定管理を pydantic-settings に移行。

変更内容:

- `config.py` を `settings.py` にリネーム
- pydantic-settings の `BaseSettings` を使用した `Settings` クラスを導入
- 便利関数を廃止し、`settings` シングルトンを直接参照するように変更
- `pyproject.toml` に `pydantic-settings>=2.0.0` を追加

```python
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    model_config = SettingsConfigDict(env_prefix="FRONTMATTER_")

    enable_semantic: bool = False
    embedding_model: str | None = None
    cache_dir: Path | None = None

    def get_cache_dir(self, base_dir: Path) -> Path:
        if self.cache_dir:
            return self.cache_dir
        return base_dir / ".frontmatter-mcp"

settings = Settings()
```

## context.py の切り出し

シングルトン管理を `server.py` から `context.py` に分離。

移動した内容:

- グローバル変数: `_base_dir`, `_embedding_model`, `_embedding_cache`, `_indexer`
- 関数: `set_base_dir()`, `get_base_dir()`, `get_embedding_model()`, `get_embedding_cache()`, `get_indexer()`, `is_indexing_ready()`

これにより `server.py` はツール定義のみに集中できるようになった。

## テストの修正

- `server_module._*` への参照を `context_module._*` に変更
- `reset_settings` autouse fixture を追加して各テストで settings を初期化
- pydantic-settings はモジュールロード時に環境変数を読むため、テストで環境変数を変更後に `Settings()` を再作成する必要あり

## 最終的な構成

```text
src/frontmatter_mcp/
├── settings.py       # pydantic-settings による設定管理
├── context.py        # シングルトン管理（base_dir, model, cache, indexer）
├── query.py          # conn_setup コールバックを受け取る
├── server.py         # ツール定義のみ
├── frontmatter.py
├── schema.py
└── semantic/
    ├── __init__.py
    ├── cache.py
    ├── indexer.py
    ├── model.py
    └── query.py
```
