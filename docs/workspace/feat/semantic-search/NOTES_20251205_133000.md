# NOTES_20251205_133000

## 背景

Obsidian Vault（660 ファイル）の探索効率化のため、frontmatter-mcp にセマンティック検索機能を追加する。現状の Grep ベースの検索では「体調が回復した日」のような意味的検索ができない。

## 決定事項

### Embedding モデル

cl-nagoya/ruri-v3-30m を採用。

選定理由:
- 日本語特化で JMTEB スコア 72.95（multilingual-e5-small の 67.38 より高い）
- 超軽量（30M パラメータ）で M1 Mac に最適
- ローカル完結、API コストゼロ

参考: https://github.com/sbintuitions/JMTEB/blob/main/leaderboard.md

### インターフェース設計

専用ツール（semantic_search）ではなく、既存 query() を拡張する方針。

理由:
- SQL で frontmatter 条件とセマンティック検索を自然に組み合わせられる
- 新しいツールを覚える必要がない
- DuckDB の組み込み関数（array_cosine_distance）を活用できる

実装:
- `embed()` カスタム関数を DuckDB に登録
- `embedding` カラムを files テーブルに追加

使用例:
```sql
SELECT path, date, 1 - array_cosine_distance(embedding, embed('体調が回復した')) as score
FROM files
WHERE date >= '2025-11-01'
ORDER BY score DESC
LIMIT 10
```

### 機能の有効化

環境変数 `FRONTMATTER_ENABLE_SEMANTIC=true` で切り替え。

fastmcp での条件付きツール登録パターンを使用:
```python
ENABLE_SEMANTIC = os.environ.get("FRONTMATTER_ENABLE_SEMANTIC", "false").lower() == "true"

if ENABLE_SEMANTIC:
    @mcp.tool()
    def index_status(): ...
```

参考: https://github.com/jlowin/fastmcp/discussions/852

### 永続化とインデックス更新

- キャッシュ: ~/.cache/frontmatter-mcp/embeddings.duckdb
- 起動時: バックグラウンドで mtime 比較、差分更新
- モデル変更時: 全ファイル再生成

## 残った検討事項

### DuckDB VSS 拡張の制約確認

- M1 Mac での動作確認が必要
- HNSW インデックスの作成タイミング（データ投入後が推奨）
- 削除されたファイルの扱い（インデックスから即時反映されない可能性）

参考: https://duckdb.org/docs/stable/core_extensions/vss

### embed() 関数の実装詳細

- DuckDB の create_function で登録する際の型定義
- 戻り値の型: FLOAT[384]（ruri-v3-30m の次元数）
- エラーハンドリング（モデル未ロード時など）

### バックグラウンド更新の実装

- Python での非同期処理（threading or asyncio）
- 更新中のクエリ挙動（古いインデックスで検索 or 待機）
- 進捗状況の取得方法（index_status で pending_count を返す想定）

### テスト戦略

- sentence-transformers のモック化（CI で重いモデルロードを避ける）
- 実際の Embedding を使った統合テストの分離

## 参照リンク

- DuckDB VSS: https://duckdb.org/docs/stable/core_extensions/vss
- JMTEB: https://github.com/sbintuitions/JMTEB
- ruri-v3-30m: https://huggingface.co/cl-nagoya/ruri-v3-30m
- fastmcp: https://github.com/jlowin/fastmcp
