# NOTES_20251205_185925

## lru_cache によるシングルトンパターンの統一

前回の NOTES_20251205_190000 で `base_dir` を環境変数に移行したが、テストのためにプロダクションコードを曲げていた。`@lru_cache` パターンを使って解決。

### 設計方針

- `base_dir` は必須フィールドとして pydantic-settings で定義
- `@lru_cache` でシングルトンを実現（テストでは `cache_clear()` でリセット可能）
- context.py のシングルトン的なグローバル変数も同様に `@lru_cache` 化

参考:
- https://stackoverflow.com/questions/61582142/test-pydantic-settings-in-fastapi
- https://github.com/pydantic/pydantic-settings/issues/410

### settings.py

```python
from functools import lru_cache

class Settings(BaseSettings):
    model_config = SettingsConfigDict(env_prefix="FRONTMATTER_")

    base_dir: Path  # Required (no default)
    enable_semantic: bool = False
    embedding_model: str | None = None
    cache_dir: Path | None = None


@lru_cache
def get_settings() -> Settings:
    return Settings()
```

### context.py

グローバル変数 + if None チェックパターンを `@lru_cache` に統一:

```python
from functools import lru_cache

@lru_cache
def get_embedding_model() -> EmbeddingModel:
    settings = get_settings()
    if settings.embedding_model:
        return EmbeddingModel(settings.embedding_model)
    return EmbeddingModel()

@lru_cache
def get_embedding_cache() -> EmbeddingCache:
    # base_dir 引数を削除、内部で get_base_dir() を呼ぶ
    ...

@lru_cache
def get_indexer() -> EmbeddingIndexer:
    # base_dir 引数を削除
    ...

def clear_context_cache() -> None:
    """Clear all cached context instances (for testing)."""
    global _indexer
    if hasattr(get_embedding_model, "cache_clear"):
        get_embedding_model.cache_clear()
    if hasattr(get_embedding_cache, "cache_clear"):
        get_embedding_cache.cache_clear()
    if hasattr(get_indexer, "cache_clear"):
        get_indexer.cache_clear()
    _indexer = None
```

`_indexer` は `is_indexing_ready()` で参照するため残す。

### server.py

`get_embedding_cache(base)` → `get_embedding_cache()` のように引数削除。

### tests/test_server.py

```python
from frontmatter_mcp.context import clear_context_cache
from frontmatter_mcp.settings import get_settings

@pytest.fixture
def temp_base_dir(monkeypatch: pytest.MonkeyPatch):
    # ...
    monkeypatch.setenv("FRONTMATTER_BASE_DIR", str(base))
    get_settings.cache_clear()
    yield base
    get_settings.cache_clear()

@pytest.fixture
def semantic_base_dir(self, temp_base_dir, monkeypatch):
    monkeypatch.setenv("FRONTMATTER_ENABLE_SEMANTIC", "true")
    get_settings.cache_clear()
    clear_context_cache()
    yield temp_base_dir
    clear_context_cache()
```

mock を使うテストでは `monkeypatch.setattr()` で関数を置き換え:

```python
monkeypatch.setattr("frontmatter_mcp.server.get_embedding_model", lambda: mock_model)
monkeypatch.setattr("frontmatter_mcp.context.get_embedding_model", lambda: mock_model)
```

### メリット

- プロダクションコードがテストのために妥協していない
- `base_dir` が必須であることが型で明示される
- シングルトンパターンが `@lru_cache` で統一され、コードが簡潔に
- `get_embedding_cache()` / `get_indexer()` から冗長な `base_dir` 引数を削除
