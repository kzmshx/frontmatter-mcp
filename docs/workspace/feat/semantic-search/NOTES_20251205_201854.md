# NOTES_20251205_201854

## FastMCP への移行

### 背景

セマンティック検索ツール (`index_status`, `index_refresh`) を `enable_semantic` が true の時のみ有効にしたい。

FastMCP では `@mcp.tool(enabled=False)` パラメータでツールを無効化し、後から `.enable()` メソッドで有効化できる。

### 変更内容

1. `mcp` SDK から `fastmcp` ライブラリに移行
   - `from mcp.server.fastmcp import FastMCP` → `from fastmcp import FastMCP`
   - `pyproject.toml` に `fastmcp>=2.13.3` を追加

2. `server.py` でのツール登録方法
   - `@mcp.tool(enabled=False)` で初期状態は無効
   - `main()` で `enable_semantic` が true なら `.enable()` を呼び出し

3. テストの修正
   - FastMCP の `@mcp.tool()` デコレータは関数を `FunctionTool` オブジェクトに変換する
   - テストで直接呼び出すには `.fn` 属性にアクセスする必要がある
   - `_call()` ヘルパー関数を追加して対応

### 実装の詳細

```python
# server.py
@mcp.tool(enabled=False)
def index_status() -> dict[str, Any]:
    ...

@mcp.tool(enabled=False)
def index_refresh() -> dict[str, Any]:
    ...

def main() -> None:
    ...
    if get_settings().enable_semantic:
        index_status.enable()
        index_refresh.enable()
        get_indexer().start()
    ...
```

```python
# test_server.py
def _call(tool_or_fn, *args, **kwargs):
    fn = getattr(tool_or_fn, "fn", tool_or_fn)
    return fn(*args, **kwargs)

# 使用例
result = _call(server_module.query_inspect, "*.md")
```
